<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Magnet.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #121212;
      height: 100%;
      width: 100%;
      overflow: hidden;
      touch-action: manipulation;
    }
    body.dark {
      background: #10131a;
    }

  /* --- CANVAS --- */
  #gameCanvas {
    display: block;
    background: transparent;
    box-shadow: 0 0 32px #b3cfff88;
    border-radius: 18px;
    image-rendering: pixelated;
    margin: auto;
    position: fixed;
    top: 0; left: 0; bottom: 0; right: 0;
    width: 100vw;
    height: 100vh;
    max-width: 1200px;
    max-height: 800px;
    z-index: 1;
  }

  @media (max-width: 900px) and (orientation: portrait) {
    #gameCanvas {
      width: 100vw;
      height: calc(100vw * 0.6667);
      max-width: 100vw;
      max-height: 100vh;
      left: 50%;
      top: 5%;
      transform: translate(-50%, 0);
    }
  }
  @media (max-height: 800px) and (orientation: landscape) {
    #gameCanvas {
      height: 100vh;
      width: calc(100vh * 1.5);
      max-width: 100vw;
      left: 50%;
      top: 20%;
      transform: translate(-50%, 0);
    }
  }

    /* --- CONTROLES MÓVIL --- */
    #mobileControls {
      position: fixed;
      bottom: 20px;
      width: 100%;
      z-index: 1000;
      pointer-events: auto;
      touch-action: none;
      display: none;
      box-sizing: border-box;
    }
    .mobile-button {
      position: absolute;
      font-size: 18px;
      padding: 14px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      pointer-events: auto;
      touch-action: none;
    }
    #btnP { right: 20px; bottom: 100px; }
    #btnE { right: 80px; bottom: 50px; }
    #btnQ { right: 20px; bottom: 20px; }

    #joystickContainer {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
      z-index: 1000;
      touch-action: none;
      pointer-events: auto;
      -webkit-user-select: none;
      user-select: none;
      display: none;
      box-sizing: border-box;
    }
    #joystick {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      position: absolute;
      touch-action: none;
      top: 25px;
      left: 25px;
    }
    #btnEsc {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      padding: 10px 20px;
      border-radius: 12px;
      background: rgba(255, 50, 50, 0.85);
      color: white;
      border: none;
      z-index: 1000;
      touch-action: none;
      display: none;
      pointer-events: auto;
      box-sizing: border-box;
    }

    /* Adaptar el campo de nombre en móvil */
@media (max-width: 700px) {
  #nameContainer {
    width: 80vw !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    top: unset !important; /* Lo controlaremos por JS */
    margin-top: 0 !important;
  }
  #playerNameInput {
    font-size: 14px !important;
    padding: 5px 8px !important;
    width: 70vw !important;
    max-width: 220px !important;
  }
  #nameContainer label {
    font-size: 14px !important;
  }
}
  </style>
</head>
<body>
<!-- Campo para el nombre del jugador SOLO visible en el menú -->
<div id="nameContainer" style="position:absolute;top:260px;left:50%;transform:translateX(-50%);z-index:10;text-align:center;display:none;">
<label for="playerNameInput" style="font-size:20px;color:#fff;margin-bottom:8px;display:block;text-shadow:1px 1px 4px #222;">Nombre:</label>
<input id="playerNameInput" type="text" maxlength="16" placeholder="Tu nombre..." style="font-size:22px;padding:8px 18px;border-radius:12px;border:1.5px solid #bbb;outline:none;text-align:center;">
</div>
  <canvas id="gameCanvas" width="1200" height="800"></canvas>

<div id="mobileControls">
  <button id="btnQ" class="mobile-button" ontouchstart="handleMobileQButton(event)">Q</button>
  <button id="btnE" class="mobile-button" ontouchstart="handleMobileEButton(event)">E</button>
  <button id="btnP" class="mobile-button" ontouchstart="handleMobilePButton(event)">P</button>
</div>

  <div id="joystickContainer">
    <div id="joystick"></div>
  </div>

  <button id="btnEsc" onclick="dispatchEscape()">ESC</button>


  <script src="/socket.io/socket.io.js"></script>
  <script src="game.js"></script>
  <script>
    function detectMobile() {
      const controls = document.getElementById('mobileControls');
      const joystickC = document.getElementById('joystickContainer');
      const btnEsc = document.getElementById('btnEsc');
      if (window.innerWidth <= 768 || /Mobi|Android|iPhone/i.test(navigator.userAgent)) {
        controls.style.display = 'block';
        joystickC.style.display = 'block';
        btnEsc.style.display = 'block';
      } else {
        controls.style.display = 'none';
        joystickC.style.display = 'none';
        btnEsc.style.display = 'none';
      }
    }
    window.addEventListener('DOMContentLoaded', detectMobile);
    window.addEventListener('resize', detectMobile);


    // --- JOYSTICK SOLO EN MÓVIL ---
    if (/Mobi|Android|iPhone/i.test(navigator.userAgent) || window.innerWidth <= 768) {
      const joystick = document.getElementById('joystick');
      const joystickContainer = document.getElementById('joystickContainer');
      let joystickActive = false;
      let startX = 0, startY = 0;

      joystickContainer.addEventListener('touchstart', function(e) {
        e.preventDefault();
        joystickActive = true;
        window.isJoystickActive = true;
        const touch = e.targetTouches[0];
        startX = touch.clientX;
        startY = touch.clientY;
      }, { passive: false });

      joystickContainer.addEventListener('touchmove', function(e) {
        if (!joystickActive) return;
        const touch = e.targetTouches[0];
        const dx = touch.clientX - startX;
        const dy = touch.clientY - startY;
        let dist = Math.sqrt(dx*dx + dy*dy);
        let maxDist = 40;
        let angle = Math.atan2(dy, dx);
        let moveX = Math.cos(angle) * Math.min(dist, maxDist);
        let moveY = Math.sin(angle) * Math.min(dist, maxDist);
        joystick.style.transform = `translate(${moveX}px, ${moveY}px)`;
        window.joystickOffsetX = moveX;
        window.joystickOffsetY = moveY;
        window.isJoystickActive = true;
      }, { passive: false });

      joystickContainer.addEventListener('touchend', function(e) {
        joystickActive = false;
        joystick.style.transform = '';
        window.joystickOffsetX = 0;
        window.joystickOffsetY = 0;
        window.isJoystickActive = false;
      }, { passive: false });

      document.getElementById('mobileControls').addEventListener('touchstart', function(e) {
        e.stopPropagation();
      }, { passive: false });
    }

    // Multitouch para botones móviles
document.querySelectorAll('.mobile-button').forEach(btn => {
  btn.addEventListener('touchstart', function(e) {
    e.stopPropagation();
    this.click();
  }, { passive: false });
});
  </script>
  <script>
function dispatchEscape() {
  if (typeof window.exitToMenu === "function") {
    window.exitToMenu();
  }
}
</script>
  <script>
  // --- SISTEMA DE NOMBRE ---
  const nameInput = document.getElementById('playerNameInput');
  // Al cargar, pon el nombre guardado o "Jugador"
  nameInput.value = localStorage.getItem('playerName') || "Jugador";
  // Cuando cambie, guarda el nombre
  nameInput.addEventListener('input', function() {
    localStorage.setItem('playerName', nameInput.value.trim() || "Jugador");
  });
  // Si el usuario pulsa Enter en el input, quita el foco
  nameInput.addEventListener('keydown', function(e) {
    if (e.key === "Enter") nameInput.blur();
  });
</script>
</body>
</html>